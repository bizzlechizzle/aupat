// ============================================
// AUPAT Database Schema
// Version 0.1.1
// PostgreSQL 16+
// ============================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Locations - Main locations table
// ============================================
model Location {
  // Primary key
  id String @id @default(uuid()) @map("loc_uuid") @db.Uuid

  // Location details
  name    String  @map("loc_name")
  akaName String? @map("aka_name")
  state   String // USPS two-letter code (lowercase)
  type    String // industrial, residential, commercial, etc.
  subType String? @map("sub_type")

  // File system paths
  originalLocation String? @map("org_loc")
  currentLocation  String? @map("loc_loc")

  // Metadata
  addedAt       DateTime? @map("loc_add") @db.Timestamptz
  updatedAt     DateTime? @map("loc_update") @db.Timestamptz
  importAuthor  String?   @map("imp_author")
  jsonUpdatedAt DateTime? @map("json_update") @db.Timestamptz

  // Relationships
  subLocations SubLocation[]
  images       Image[]
  videos       Video[]
  documents    Document[]
  urls         Url[]

  // Indexes
  @@index([state, type], name: "idx_locations_state_type")
  @@index([state])
  @@index([type])
  @@map("locations")
}

// ============================================
// SubLocations - Sub-locations within main locations
// ============================================
model SubLocation {
  // Primary key
  id String @id @default(uuid()) @map("sub_uuid") @db.Uuid

  // Sub-location details
  name String @map("sub_name")

  // Parent location
  locationId String   @map("loc_uuid") @db.Uuid
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  // File system paths
  originalLocation String? @map("org_loc")
  currentLocation  String? @map("loc_loc")

  // Metadata
  addedAt      DateTime? @map("loc_add") @db.Timestamptz
  updatedAt    DateTime? @map("loc_update") @db.Timestamptz
  importAuthor String?   @map("imp_author")

  // Relationships
  images    Image[]
  videos    Video[]
  documents Document[]
  urls      Url[]

  @@map("sub_locations")
}

// ============================================
// Images - Photo files with metadata
// ============================================
model Image {
  // Primary key (SHA256 hash)
  sha256 String @unique @map("img_sha256")

  // File details
  name     String @map("img_name")
  filePath String @map("img_loc")

  // Hardware categorization flags
  isOriginal Boolean? @map("original")
  isCamera   Boolean? @map("camera")
  isPhone    Boolean? @map("phone")
  isDrone    Boolean? @map("drone")
  isGoPro    Boolean? @map("go_pro")
  isFilm     Boolean? @map("film")
  isOther    Boolean? @map("other")

  // Hardware metadata (JSON)
  exiftoolHardware Json? @map("exiftool_hardware") @db.Json
  hardwareInfo     Json? @map("img_hardware") @db.Json // {make, model, category}

  // Parent relationships
  locationId String   @map("loc_uuid") @db.Uuid
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  subLocationId String?      @map("sub_uuid") @db.Uuid
  subLocation   SubLocation? @relation(fields: [subLocationId], references: [id], onDelete: SetNull)

  // Original file info
  originalLocation String? @map("img_loco")
  originalName     String? @map("img_nameo")

  // Metadata
  addedAt      DateTime? @map("img_add") @db.Timestamptz
  updatedAt    DateTime? @map("img_update") @db.Timestamptz
  importAuthor String?   @map("imp_author")

  // Related media (JSON arrays of SHA256)
  relatedDocs   Json? @map("img_docs") @db.Json // Array of doc_sha256
  relatedVideos Json? @map("img_vids") @db.Json // Array of vid_sha256 (live photos)

  // Indexes
  @@index([locationId], name: "idx_images_loc_uuid")
  @@index([locationId, isCamera], name: "idx_images_camera")
  @@index([sha256])
  @@map("images")
}

// ============================================
// Videos - Video files with metadata
// ============================================
model Video {
  // Primary key (SHA256 hash)
  sha256 String @unique @map("vid_sha256")

  // File details
  name     String @map("vid_name")
  filePath String @map("vid_loc")

  // Hardware categorization flags
  isOriginal Boolean? @map("original")
  isCamera   Boolean? @map("camera")
  isDrone    Boolean? @map("drone")
  isPhone    Boolean? @map("phone")
  isGoPro    Boolean? @map("go_pro")
  isDashCam  Boolean? @map("dash_cam")
  isOther    Boolean? @map("other")

  // Hardware metadata (JSON)
  ffmpegHardware Json? @map("ffmpeg_hardware") @db.Json
  hardwareInfo   Json? @map("vid_hardware") @db.Json // {make, model, category}

  // Parent relationships
  locationId String   @map("loc_uuid") @db.Uuid
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  subLocationId String?      @map("sub_uuid") @db.Uuid
  subLocation   SubLocation? @relation(fields: [subLocationId], references: [id], onDelete: SetNull)

  // Original file info
  originalLocation String? @map("vid_loco")
  originalName     String? @map("vid_nameo")

  // Metadata
  addedAt      DateTime? @map("vid_add") @db.Timestamptz
  updatedAt    DateTime? @map("vid_update") @db.Timestamptz
  importAuthor String?   @map("imp_author")

  // Related media (JSON arrays of SHA256)
  relatedDocs   Json? @map("vid_docs") @db.Json // Array of doc_sha256
  relatedImages Json? @map("vid_imgs") @db.Json // Array of img_sha256 (live videos)

  // Indexes
  @@index([locationId], name: "idx_videos_loc_uuid")
  @@index([locationId, isDrone], name: "idx_videos_drone")
  @@index([sha256])
  @@map("videos")
}

// ============================================
// Documents - Document files (PDFs, subtitles, etc.)
// ============================================
model Document {
  // Primary key (SHA256 hash)
  sha256 String @unique @map("doc_sha256")

  // File details
  name      String @map("doc_name")
  filePath  String @map("doc_loc")
  extension String @map("doc_ext") // .pdf, .srt, .xml, etc.

  // Parent relationships
  locationId String   @map("loc_uuid") @db.Uuid
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  subLocationId String?      @map("sub_uuid") @db.Uuid
  subLocation   SubLocation? @relation(fields: [subLocationId], references: [id], onDelete: SetNull)

  // Original file info
  originalLocation String? @map("doc_loco")
  originalName     String? @map("doc_nameo")

  // Metadata
  addedAt      DateTime? @map("doc_add") @db.Timestamptz
  updatedAt    DateTime? @map("doc_update") @db.Timestamptz
  importAuthor String?   @map("imp_author")

  // Related media (JSON array of SHA256)
  relatedImages Json? @map("docs_img") @db.Json // Array of img_sha256

  // Indexes
  @@index([locationId], name: "idx_documents_loc_uuid")
  @@index([extension], name: "idx_documents_ext")
  @@index([sha256])
  @@map("documents")
}

// ============================================
// URLs - URL references with domain tracking
// ============================================
model Url {
  // Primary key
  id String @id @default(uuid()) @map("url_uuid") @db.Uuid

  // URL details
  url             String
  domain          String // Full domain without normalization
  storageLocation String? @map("url_loc") // Path for archived content

  // Parent relationships
  locationId String   @map("loc_uuid") @db.Uuid
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  subLocationId String?      @map("sub_uuid") @db.Uuid
  subLocation   SubLocation? @relation(fields: [subLocationId], references: [id], onDelete: SetNull)

  // Metadata
  addedAt      DateTime? @map("url_add") @db.Timestamptz
  updatedAt    DateTime? @map("url_update") @db.Timestamptz
  importAuthor String?   @map("imp_author")

  // Indexes
  @@index([locationId], name: "idx_urls_loc_uuid")
  @@index([domain], name: "idx_urls_domain")
  @@map("urls")
}

// ============================================
// Versions - Track module and schema versions
// ============================================
model Version {
  // Primary key
  module String @id @map("modules")

  // Version info
  version   String
  updatedAt DateTime @map("ver_updated") @db.Timestamptz

  @@map("versions")
}
